name: Build Audio HAL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      device_codename:
        description: 'Device Codename (e.g., Mi439)'
        required: true
        default: 'Mi439'
      build_variant:
        description: 'Build Variant (e.g., userdebug)'
        required: true
        default: 'userdebug'
      target_module:
        description: 'Target Module to build'
        required: true
        default: 'hardware/qcom/audio/hal'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses-dev lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python-is-python3 openjdk-11-jdk

      - name: Create minimal build tree
        run: |
          mkdir -p lineageos-source
          cd lineageos-source
          mkdir -p build/make/core
          mkdir -p vendor/lineage/build
          # Create dummy envsetup.sh scripts
          echo "source build/make/core/envsetup.sh" > build/envsetup.sh
          touch build/make/core/envsetup.sh
          touch vendor/lineage/build/envsetup.sh
          # Create core build files for mmm
          echo 'GET_BUILD_VAR_DEFS := $(dump-many-vars)' > build/make/core/config.mk
          echo '.PHONY: $(TARGET_PRODUCT)' > build/make/core/main.mk

      - name: Prepare HAL source
        run: |
          # Copy our HAL source into the correct location in the minimal tree
          mkdir -p lineageos-source/hardware/qcom/audio
          cp -r hal_source lineageos-source/hardware/qcom/audio/hal

      - name: Set up build environment
        run: |
          cd lineageos-source
          source build/envsetup.sh
          export TARGET_PRODUCT=lineage_${{ github.event.inputs.device_codename }}
          export TARGET_BUILD_VARIANT=${{ github.event.inputs.build_variant }}
          export OUT_DIR_COMMON_BASE=out

      - name: Build HAL module
        run: |
          cd lineageos-source
          mmm ${{ github.event.inputs.target_module }} -j$(nproc --all)

      - name: Find and upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audio-hal-build
          path: |
            lineageos-source/out/target/product/${{ github.event.inputs.device_codename }}/system/lib/hw/audio.primary.*.so
            lineageos-source/out/target/product/${{ github.event.inputs.device_codename }}/system/lib64/hw/audio.primary.*.so
            lineageos-source/out/target/product/${{ github.event.inputs.device_codename }}/vendor/lib/hw/audio.primary.*.so
            lineageos-source/out/target/product/${{ github.event.inputs.device_codename }}/vendor/lib64/hw/audio.primary.*.so
